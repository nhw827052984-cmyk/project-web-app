import sys
from flask import Flask, request, jsonify, render_template
from urllib.parse import quote_plus
import webbrowser # (虽然 submit_feedback 被禁用，但保留导入也没问题)

# --- 1. 启动 Flask 应用 ---
app = Flask(__name__)

# --- 2. 复制您 V25 的所有核心逻辑 (完整版) ---

# --- 第2点：技术方案“自动定级”的规则库 (V25 完整版) ---
PLAN_LEVELS_DB = {
    "水电站项目": {
        "项目前期设计阶段": {
            "勘测设计招标文件（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "勘测设计科研工作大纲（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "设计主报告及附图（含预可研、可研、概念设计、基础设计等）": ("Ⅱ类", "Ⅱ类", "Ⅱ类（投资）/Ⅲ类（承包）"),
            "重要专题报告（正常蓄水位选择、枢纽布置格局比选、施工总布置规划、项目核准申请报告等）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "其他科研和专题报告": ("Ⅲ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "投标技术方案（设计技术方案、施工组织总设计方案）": ("Ⅱ类", "Ⅱ类", "Ⅲ类"),
        },
        "招标设计阶段": {
            "招标设计报告、分标规划报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "主体工程施工和安装招标文件及附图": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "关键永久机电设备招标文件及附图（如：水轮发电机组）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "其他招标文件及附图": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "施工详图设计文件": {
            "综合性设计方案图纸（如：枢纽总布置图、枢纽区工程地质图、施工总布置图、施工总进度等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "重要的系统原理图（水系统、电气主接线、继电保护等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它图纸（地质图、布置结构图、细部设计图，边坡处理，渗控工程，安全监测等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重要的专题、计算分析、试验研究报告（如：水工模型试验、水库调度规程等）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般的计算分析、试验报告（土工材料试验、混凝土配合比试验等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "施工度汛设计报告或要求": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "重要的施工技术要求（挡水、泄水、输水、发电厂房、通航等重要主体建筑物）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "一般的施工技术要求": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量问题设计复核及处理报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般质量问题或缺陷设计复核及处理报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程施工技术文件": {
            "项目实施性施工组织总设计方案": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "单位工程施工组织设计、分部（分项）工程施工组织设计": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "境内项目和重点管控项目专项施工方案（危大工程和超危大工程）": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "境外非公司重点监控项目专项施工方案（危大工程和超危大工程）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它施工技术文件（施工计划、施工措施、施工工艺、作业指导书、操作规程、试验大纲、竣工图、水电站设备运行维护检修规程等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量（安全）事故（隐患）的处理（整改）措施": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般质量（安全）问题（隐患）的处理（整改）措施": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类会议纪要（设联会、图纸会审、例会、专题会等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类记录（图纸会审、技术交底、施工、培训、检验、试验、调试、试运行、验收、观测、检测、交接、事故处理等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "其它建设管理技术文件（工作联系单、技术核定T单、材料代用单、工程量签证单等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程验收技术文件（投资项目）": {
            "分部、分项工程验收": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "单位工程验收": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "阶段验收（截流、蓄水和机组启动）": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "专项验收（枢纽工程、建设征地移民安置、环境保护、水土保持、消防、工程档案等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "合同工程完工验收/工程竣工验收": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
        }
    },
    "风电、光伏、储能及输变电项目": {
        "项目前期设计阶段": {
            "勘测设计招标文件（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "勘测设计科研工作大纲（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "设计主报告及附图（含预可研、可研、初步设计等）": ("Ⅱ类", "Ⅱ类", "Ⅱ类（投资）/Ⅲ类（承包）"),
            "重要的专题报告（含资源评估报告、规划报告、微观选址报告等）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "其他科研和专题报告": ("Ⅲ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "投标技术方案（设计技术方案、施工组织总设计方案）": ("Ⅱ类", "Ⅱ类", "Ⅲ类"),
        },
        "招标设计阶段": {
            "招标设计报告、分标规划": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "主体工程施工和安装招标文件": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "关键永久机电设备招标文件（如：风机、光伏组件、储能系统等）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "其他招标文件及附图": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "施工详图设计文件": {
            "综合性设计方案图纸（如：风电场、光伏电站总平面布置图、施工总平面布置图等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "重要的原理图（如：电气主接线图、继电保护配置图等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它图纸（如：布置图、基础处理、边坡处理、构造图、钢筋图、大样图、安装图、零件图等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大专题、计算分析和研究报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般的计算分析、试验报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "施工度汛设计报告或要求": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "各类施工技术要求": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量问题设计复核及处理报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般质量问题或缺陷设计复核及处理报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程施工技术文件": {
            "项目实施性施工组织总设计方案": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "单位工程施工组织设计、分部（分项）工程施工组织设计": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "境内项目和重点管控项目专项施工方案（危大工程和超危大工程）": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "境外非公司重点监控项目专项施工方案（危大工程和超危大工程）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它施工技术文件（施工计划、施工措施、施工工艺、作业指导书、操作规程、试验大纲、竣工图等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量（安全）事故（隐患）的处理（整改）措施": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般质量（安全）问题（隐患）的处理（整改）措施": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类会议纪要（设联会、图纸会审、例会、专题会等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类记录（图纸会审、技术交底、施工、培训、检验、试验、调试、试运行、验收、观测、检测、交接、事故处理等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "其它建设管理技术文件（工作联系单、技术核定单、材料代用单、工程量签证单等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程验收技术文件（投资项目）": {
            "分部、分项工程验收": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "单位工程验收": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "专项验收（环保、水保、消防、安全、计量、档案等）、工程移交生产验收（如需）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "工程启动验收、竣工验收": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
        }
    },
    "路桥项目": {
        "项目前期设计阶段": {
            "勘测设计招标文件（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "勘测设计科研工作大纲（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "设计主报告及附图（含预可研、可研等）": ("Ⅱ类", "Ⅱ类", "Ⅱ类（投资）/Ⅲ类（承包）"),
            "其他科研和专题报告": ("Ⅲ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "投标技术方案（交通量分析、设计技术方案、施工组织总设计方案、经济评价）": ("Ⅱ类", "Ⅱ类", "Ⅲ类"),
        },
        "初步设计阶段（含技术设计阶段）": {
            "初步设计报告和图纸": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "技术设计报告和图纸（如有）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "土建招标文件": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "机电工程招标文件": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "施工详图设计文件": {
            "综合性设计方案图纸（如：路线总体平面布置图、互通立交总体布置图、特大桥梁平面布置图、特长隧道平面布置图等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "重要设计方案图纸（如：大桥桥型布置图、隧道纵断面图、互通与枢纽设计图等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它图纸（如：箱梁一般构造图、桥墩一般构造图、承台一般构造图、桩基一般构造图、隧道衬砌布置图、细部构造、钢筋图、大样图等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大专题、计算分析和研究报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般的计算分析、试验报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "施工度汛设计报告或要求": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "各类施工技术要求": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量问题设计复核及处理报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般质量问题或缺陷设计复核及处理报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程施工技术文件": {
            "项目实施性施工组织总设计方案": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "单位工程施工组织设计、分部（分项）工程施工组织设计": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "首件工程方案、试验段方案等": ("Ⅳ类", "Ⅳ类", "Ⅳ类"), 
            "境内项目和重点管控项目专项施工方案（危大工程和超危大工程）": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "境外非公司重点监控项目专项施工方案（危大工程和超危大工程）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它施工技术文件（施工计划、施工措施、施工工艺、作业指导书、操作规程、试验大纲、竣工图等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量（安全）事故（隐患）的处理（整改）措施": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般质量（安全）问题（隐患）的处理（整改）措施": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类会议纪要（设联、图纸会审、例会、专题会等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类记录（图纸会审、技术交底、施工、培训、检验、试验、调试、试运行、验收、观测、检测、交接、事故处理等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "其它建设管理技术文件（工作联系单、技术核定单、材料代用单、工程量签证单等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程验收技术文件（投资项目）": {
            "分部、分项工程验收": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "单位工程验收": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "工程交工验收": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "竣工验收": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
        }
    },
    "自来水厂和污水处理厂项目": {
        "项目前期设计阶段": {
            "勘测设计招标文件（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "勘测设计科研工作大纲（各阶段）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "设计主报告及附图（含可研、初步设计等）": ("Ⅱ类", "Ⅱ类", "Ⅱ类（投资）/Ⅲ类（承包）"),
            "其他科研和专题报告": ("Ⅲ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "投标技术方案（设计技术方案、施工组织总设计方案）": ("Ⅱ类", "Ⅱ类", "Ⅲ类"),
        },
        "招标设计阶段": {
            "招标设计报告、分标规划": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "主体工程施工和安装招标文件": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "关键永久机电设备招标文件（如：净水设备等）": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "非主体工程和非关键设备的招标文件": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "施工详图设计文件": {
            "综合性设计方案图纸（如：厂区平面布置图、施工总平面布置图等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "重要设计方案图纸（如：P&ID 图纸、工艺图纸、建筑图纸、机械图纸、电气主接线图、高压电气设备布置图、防雷保护范围图等）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它图纸（如：基础处理、边坡处理、细部构造、钢筋图、大样图、安装图、零件图等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大专题、计算分析和研究报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般的计算分析、试验报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "施工度汛设计报告或要求": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "各类施工技术要求": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各种测量、勘探、试验成果": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大设计变更报告": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般设计变更报告或通知": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量问题设计复核及处理报告": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "一般质量问题或缺陷设计复核及处理报告": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程施工技术文件": {
            "项目实施性施工组织总设计方案": ("Ⅱ类", "Ⅲ类", "Ⅲ类"),
            "单位工程施工组织设计、分部分项工程施工组织设计": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "首件工程方案、试验段方案等": ("Ⅳ类", "Ⅳ类", "Ⅳ类"), 
            "境内项目和重点管控项目专项施工方案（危大工程和超危大工程）": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "境外非公司重点监控项目专项施工方案（危大工程和超危大工程）": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "其它施工技术文件（施工计划、施工措施、施工工艺、作业指导书、操作规程、试验大纲、竣工图等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "重大质量（安全）事故（隐患）的处理（整改）措施": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
            "一般质量（安全）问题（隐患）的处理（整改）措施": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类会议纪要（设联会、图纸会审、例会、专题会等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "各类记录（图纸会审、技术交底、施工、培训、检验、试验、调试、试运行、验收、观测、检测、交接、事故处理等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "其它建设管理技术文件（工作联系单、技术核定单、材料代用单、工程量签证单等）": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
        },
        "工程验收技术文件（投资项目）": {
            "分部、分项工程验收": ("Ⅳ类", "Ⅳ类", "Ⅳ类"),
            "单位工程验收": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "工程交工验收": ("Ⅲ类", "Ⅲ类", "Ⅲ类"),
            "竣工验收": ("Ⅱ类", "Ⅱ类", "Ⅱ类"),
        }
    }
}
# --- 审批流文本 ---
APPROVAL_FLOW_DB = {
    "Ⅰ类": "项目部(内审) -> 项目主管部门(审查) -> 科数部(组织审核) -> 相关部门(参与审核) -> T技委会/第三方(审核) -> 公司总工(审核) -> 集团科数部(审查) -> 集团总工(审批)。",
    "Ⅱ类": "项目部(内审) -> 项目主管部门(审查) -> 科数部(组织审核) -> 相关部门(参与审核) -> 技委会/第三方(审核) -> 公司总工(审批)。",
    "Ⅲ类": "项目部(内审) -> 项目主管部门(审查)。科数部(审批或协助审查)。",
    "Ⅳ类": "项目部(审查) -> 项目主管部门(审批)。"
}
# --- 审批流图示结构 ---
FLOWCHART_STRUCTURES = {
    "Ⅰ类": [("项目部", "内审"),
            ("项目主管部门", "审查"),
            ("科数部", "组织审核"),
            ("相关部门", "参与审核"),
            ("技委会/第三方机构", "审核"),
            ("公司总工", "审核"),
            ("集团科数部", "审查"),
            ("集团总工", "审批")],
    "Ⅱ类": [("项目部", "内审"),
            ("项目主管部门", "审查"),
            ("科数部", "组织审核"),
            ("相关部门", "参与审核"),
            ("技委会/第三方机构", "审核"),
            ("公司总工", "审批")],
    "Ⅲ类": [("项目部", "内审"),
            ("项目主管部门", "审查"),
            ("科数部", "审批或协助审查")],
    "Ⅳ类": [("项目部", "审查"),
            ("项目主管部门", "审批")]
}

# --- 辅助函数 (原封不动) ---
def get_amount_index(contract_amount: float) -> int:
    if contract_amount > 200_000_000: return 0
    elif 50_000_000 <= contract_amount <= 200_000_000: return 1
    elif contract_amount < 50_000_000: return 2
    else: return -1  

def strip_prefix(s: str) -> str:
    parts = s.split(". ", 1)
    if len(parts) == 2 and parts[0].isdigit(): return parts[1]
    return s 

def get_plan_level(project_type: str, project_phase: str, document_name: str, contract_amount: float) -> str:
    amount_index = get_amount_index(contract_amount)
    if amount_index == -1: return f"错误：无效的合同金额 {contract_amount}"
    if "其他（默认为IV类）" in document_name: return "Ⅳ类"
    try:
        project_phases = PLAN_LEVELS_DB.get(project_type)
        if not project_phases: return "Ⅳ类(规则未覆盖: 项目类型)" 
        phase_documents = project_phases.get(project_phase)
        if not phase_documents: return "Ⅳ类(规则未覆盖: 项目阶段)" 
        levels = phase_documents.get(document_name)
        if not levels: return "Ⅳ类(规则未覆盖: 技术文件)" 
        if not isinstance(levels, (list, tuple)) or len(levels) <= amount_index:
            return f"错误：规则定义不完整 (文件: {document_name}, 索引: {amount_index})"
        return levels[amount_index]
    except Exception as e: return f"错误：未知查询失败 {e}"

def get_approval_flow_data(plan_level: str) -> dict:
    """网页版升级：同时返回文本和图示结构"""
    clean_level = plan_level.split("（")[0].strip()
    
    if "错误：" in clean_level or "规则未覆盖" in clean_level:
        return {
            "level": "错误",
            "description": "查询定级失败，无法获取审批流。",
            "steps": []
        }
    
    description = APPROVAL_FLOW_DB.get(clean_level, f"错误：未找到级别 '{plan_level}' 对应的审批流。")
    steps = FLOWCHART_STRUCTURES.get(clean_level, [])
    
    return {
        "level": clean_level,
        "description": description, # 审批流文本 (网页版可以决定是否显示)
        "steps": steps          # 给画布画图用的步骤
    }

# --- 3. 创建网页的“路由” (Routes) ---

@app.route("/")
def index():
    """
    当用户访问根目录 (/) 时，渲染 index.html 网页。
    """
    # 动态地将项目类型列表传递给网页
    project_types_list = [f"{i+1}. {name}" for i, name in enumerate(PLAN_LEVELS_DB.keys())]
    return render_template("index.html", project_types=project_types_list)

@app.route("/api/get_phases", methods=['POST'])
def api_get_phases():
    """API：根据项目类型获取项目阶段"""
    data = request.json
    project_type_key = strip_prefix(data.get("project_type", ""))
    
    if project_type_key in PLAN_LEVELS_DB:
        phase_keys = list(PLAN_LEVELS_DB[project_type_key].keys())
        phase_options = [f"{i+1}. {name}" for i, name in enumerate(phase_keys)]
        return jsonify(success=True, phases=phase_options)
    return jsonify(success=False, phases=[])

@app.route("/api/get_documents", methods=['POST'])
def api_get_documents():
    """API：根据项目类型和阶段获取技术文件"""
    data = request.json
    project_type_key = strip_prefix(data.get("project_type", ""))
    project_phase_key = strip_prefix(data.get("project_phase", ""))
    
    try:
        doc_keys = list(PLAN_LEVELS_DB[project_type_key][project_phase_key].keys())
        doc_options = [f"{i+1}. {name}" for i, name in enumerate(doc_keys)] 
        doc_options.append("其他（默认为IV类）")
        return jsonify(success=True, documents=doc_options)
    except KeyError:
        return jsonify(success=True, documents=["其他（默认为IV类）"]) # 即使KeyError也返回默认值

@app.route("/api/query", methods=['POST'])
def api_query():
    """
    核心API：执行查询
    """
    data = request.json # 接收网页发来的JSON数据
    
    proj_type_key = strip_prefix(data.get("project_type", ""))
    proj_phase_key = strip_prefix(data.get("project_phase", ""))
    doc_name_key = strip_prefix(data.get("document_name", ""))
    
    try:
        amount_input = float(data.get("amount", 0))
    except ValueError:
        return jsonify(success=False, error="金额必须是数字"), 400

    # --- 复用您的核心逻辑 ---
    final_usd_amount = amount_input * 10_000 # 网页端固定为“万美元”
    level_raw = get_plan_level(proj_type_key, proj_phase_key, doc_name_key, final_usd_amount)
    
    # 获取定级和流程图数据
    flow_data = get_approval_flow_data(level_raw)
    
    # 将结果打包成JSON发回给网页
    return jsonify(
        success=True,
        result_level=level_raw,
        flowchart=flow_data 
    )

#
# --- V2.1 部署修复：注释掉（禁用）这个函数 ---
# 
# 原因是：`webbrowser.open_new_tab` 无法在云服务器上运行，会导致崩溃。
# 反馈逻辑已经由 /static/script.js 在用户的浏览器上处理了。
#
"""
@app.route("/api/submit_feedback", methods=['POST'])
def api_submit_feedback():
    data = request.json
    feedback_text = data.get("feedback_text", "").strip()
    if not feedback_text:
        return jsonify(success=False, error="内容为空"), 400
        
    BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf0BLi0d_Hlsha7nvux9P6nzlX8rxUQMykgg3GSZfCV-S9LGg/viewform?usp=pp_url"
    ENTRY_ID = "entry.259679197"
    
    encoded_text = quote_plus(feedback_text)
    final_url = f"{BASE_URL}&{ENTRY_ID}={encoded_text}"
    
    try:
        webbrowser.open_new_tab(final_url) 
        return jsonify(success=True, message="已在服务器浏览器中打开，请提交。")
    except Exception as e:
        print(f"打开浏览器失败: {e}")
        return jsonify(success=False, error=str(e)), 500
"""

# --- 4. 运行服务器 ---
if __name__ == "__main__":
    # debug=True 意味着您保存代码时，服务器会自动重启
    # host='0.0.0.0' 意味着局域网内的其他电脑也可以访问
    app.run(debug=True, host='0.0.0.0', port=5000)